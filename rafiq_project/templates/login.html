{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Log in â€” RAFIQ</title>
  <link rel="stylesheet" href="{% static 'css/auth.css' %}">
</head>
<body>
  <main class="card">
    <h1>Sign in</h1>
    <form id="login-form" autocomplete="off" method="post">
      {% csrf_token %}
      <div class="row">
        <label>Email
          <input name="email" type="email" required>
        </label>
      </div>
      <div class="row">
        <label>Password
          <input name="password" type="password" required>
        </label>
      </div>
      <div class="row">
        <button type="submit" class="btn">Sign in</button>
      </div>
      <div id="msg" class="msg" role="status"></div>
      <p class="small">
        No account?
        <a href="{% url 'signup_page' %}">Create one</a>
      </p>
      <p class="small">
          Forgot your password?
          <a href="{% url 'password_reset_request_page' %}">Reset it</a>
      </p>
    </form>
  </main>

  <script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('login-form');
  const msg = document.getElementById('msg');

  // Ø¬Ù„Ø¨ ÙƒÙˆÙƒÙŠØ² (Ù…ÙÙŠØ¯ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ csrftoken)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ CSRF token (Ù…Ù† Ø§Ù„ÙƒÙˆÙƒÙŠØ² Ø£Ùˆ Ù…Ù† input hidden)
  function getCsrfToken() {
    let token = getCookie('csrftoken');
    if (token) return token;
    const input = form.querySelector('input[name="csrfmiddlewaretoken"]');
    if (input) return input.value;
    return null;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    msg.textContent = '';
    msg.classList.remove('success', 'error');

    // Ø¨Ù†Ø§Ø¡ payload Ø¨ØµÙŠØºØ© form-encoded (backend Ù…ØªÙˆÙ‚Ø¹ email + password)
    const payload = new URLSearchParams();
    payload.append('email', form.email.value.trim());
    payload.append('password', form.password.value);

    const csrftoken = getCsrfToken();
    console.log('csrftoken:', csrftoken);

    try {
      const res = await fetch('/api/accounts/login/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          ...(csrftoken ? {'X-CSRFToken': csrftoken} : {})
        },
        credentials: 'same-origin',
        body: payload.toString()
      });

      // Ø§Ù‚Ø±Ø£ Ø§Ù„Ù€ body Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙƒÙ€ text Ø«Ù… Ø­Ø§ÙˆÙÙ„ Ø¹Ù…Ù„ JSON.parse
      const text = await res.text();
      let json = null;
      try {
        json = text ? JSON.parse(text) : null;
      } catch (parseErr) {
        // Ù„Ùˆ Ù…Ø´ JSON Ù†Ø­ØªÙØ¸ Ø¨Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ ÙÙŠ Ù…ØªØºÙŠØ± text
        json = null;
      }

      // Ù„Ùˆ Ø·Ù„Ø¨ ØºÙŠØ± OK â€” Ù‚Ø±Ø± Ø£ÙŠ Ø±Ø³Ø§Ù„Ø© Ù†Ø¹Ø±Ø¶Ù‡Ø§
      if (!res.ok) {
        // Ø£ÙØ¶Ù„ Ø±Ø³Ø§Ø¦Ù„ Ù…Ù…ÙƒÙ† ØªØ±Ø¬Ø¹Ù‡Ø§ API: detail, non_field_errors, Ø£Ùˆ Ø±Ø³Ø§Ø¦Ù„ Ø­Ù‚Ù„ÙŠØ©
        const errDetail =
          json?.detail ||
          (json && typeof json === 'object' ? Object.values(json).flat().join(' | ') : text) ||
          `Server returned ${res.status}`;
        throw { detail: errDetail };
      }

      // Ù„Ùˆ ÙˆØµÙ„ Ù‡Ù†Ø§ØŒ ÙØ§Ù„Ù€ response Ù†Ø§Ø¬Ø­
      const token = (json && (json.token || json.key)) || '';
      if (token) {
        localStorage.setItem('authToken', token);
      } else {
        console.warn('Login succeeded but no token in response:', json, text);
      }

      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø¥Ù† ÙˆÙØ¬Ø¯ endpoint
      if (token) {
        try {
          const profileRes = await fetch('/api/accounts/profile/', {
            headers: { 'Authorization': 'Token ' + token },
            credentials: 'same-origin'
          });
          if (profileRes.ok) {
            const profileText = await profileRes.text();
            let profileJson = null;
            try { profileJson = profileText ? JSON.parse(profileText) : null; } catch { profileJson = null; }
            if (profileJson) {
              localStorage.setItem('user', JSON.stringify(profileJson));
            }
          } else {
            console.warn('Profile fetch returned', profileRes.status);
          }
        } catch (pfErr) {
          console.warn('Profile fetch failed:', pfErr);
        }
      }

      msg.textContent = 'ğŸ‰Signed in successfully â€” redirecting...';
      msg.classList.add('success');

      // Redirect Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø¹Ø¯Ù„ÙŠ Ø§Ù„Ù…Ø³Ø§Ø± Ø­Ø³Ø¨ Ø­Ø§Ø¬ØªÙƒ)
      // setTimeout(() => {
      //   window.location.href = '/templates/profile.html';
      // }, 900);

    } catch (err) {
      console.error('Login error:', err);
      // "err" Ù…Ù…ÙƒÙ† ÙŠÙƒÙˆÙ† Ø´ÙƒÙ„ { detail: '...' } Ø£Ùˆ Error object
      const message = err?.detail || err?.message || 'Login failed. Please check your credentials.';
      msg.textContent = message;
      msg.classList.add('error');
    }
  });
});
</script>

</body>
</html>