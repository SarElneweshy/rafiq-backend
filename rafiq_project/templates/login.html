{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Log in — RAFIQ</title>
  <link rel="stylesheet" href="{% static 'css/auth.css' %}">
</head>
<body>
  <main class="card">
    <h1>Sign in</h1>
    <form id="login-form" autocomplete="off" method="post">
      {% csrf_token %}
      <div class="row">
        <label>Email
          <input name="email" type="email" required>
        </label>
      </div>
      <div class="row">
        <label>Password
          <input name="password" type="password" required>
        </label>
      </div>
      <div class="row">
        <button type="submit" class="btn">Sign in</button>
      </div>
      <div id="msg" class="msg" role="status"></div>
      <p class="small">
        No account?
        <a href="{% url 'signup_page' %}">Create one</a>
      </p>
      <p class="small">
          Forgot your password?
          <a href="{% url 'password_reset_request_page' %}">Reset it</a>
      </p>
    </form>
  </main>

  <script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('login-form');
  const msg = document.getElementById('msg');

  // جلب كوكيز (مفيد للحصول على csrftoken)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // محاولة الحصول على CSRF token (من الكوكيز أو من input hidden)
  function getCsrfToken() {
    let token = getCookie('csrftoken');
    if (token) return token;
    const input = form.querySelector('input[name="csrfmiddlewaretoken"]');
    if (input) return input.value;
    return null;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    msg.textContent = '';
    msg.classList.remove('success', 'error');

    // بناء payload بصيغة form-encoded (backend متوقع email + password)
    const payload = new URLSearchParams();
    payload.append('email', form.email.value.trim());
    payload.append('password', form.password.value);

    const csrftoken = getCsrfToken();
    console.log('csrftoken:', csrftoken);

    try {
      const res = await fetch('/api/accounts/login/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          ...(csrftoken ? {'X-CSRFToken': csrftoken} : {})
        },
        credentials: 'same-origin',
        body: payload.toString()
      });

      // اقرأ الـ body مرة واحدة كـ text ثم حاوِل عمل JSON.parse
      const text = await res.text();
      let json = null;
      try {
        json = text ? JSON.parse(text) : null;
      } catch (parseErr) {
        // لو مش JSON نحتفظ بالنص الأصلي في متغير text
        json = null;
      }

      // لو طلب غير OK — قرر أي رسالة نعرضها
      if (!res.ok) {
        // أفضل رسائل ممكن ترجعها API: detail, non_field_errors, أو رسائل حقلية
        const errDetail =
          json?.detail ||
          (json && typeof json === 'object' ? Object.values(json).flat().join(' | ') : text) ||
          `Server returned ${res.status}`;
        throw { detail: errDetail };
      }

      // لو وصل هنا، فالـ response ناجح
      const token = (json && (json.token || json.key)) || '';
      if (token) {
        localStorage.setItem('authToken', token);
      } else {
        console.warn('Login succeeded but no token in response:', json, text);
      }

      // محاولة جلب بيانات البروفايل إن وُجد endpoint
      if (token) {
        try {
          const profileRes = await fetch('/api/accounts/profile/', {
            headers: { 'Authorization': 'Token ' + token },
            credentials: 'same-origin'
          });
          if (profileRes.ok) {
            const profileText = await profileRes.text();
            let profileJson = null;
            try { profileJson = profileText ? JSON.parse(profileText) : null; } catch { profileJson = null; }
            if (profileJson) {
              localStorage.setItem('user', JSON.stringify(profileJson));
            }
          } else {
            console.warn('Profile fetch returned', profileRes.status);
          }
        } catch (pfErr) {
          console.warn('Profile fetch failed:', pfErr);
        }
      }

      msg.textContent = '🎉Signed in successfully — redirecting...';
      msg.classList.add('success');

      // Redirect بعد تسجيل الدخول (عدلي المسار حسب حاجتك)
      // setTimeout(() => {
      //   window.location.href = '/templates/profile.html';
      // }, 900);

    } catch (err) {
      console.error('Login error:', err);
      // "err" ممكن يكون شكل { detail: '...' } أو Error object
      const message = err?.detail || err?.message || 'Login failed. Please check your credentials.';
      msg.textContent = message;
      msg.classList.add('error');
    }
  });
});
</script>

</body>
</html>